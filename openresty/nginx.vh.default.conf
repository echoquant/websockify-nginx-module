server {
    listen       80;
    server_name  localhost;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    location /websockify {
      resolver 127.0.0.11 valid=30s ipv6=off;

      set $dst_addr '';
      access_by_lua '

          -- your private key here
          local key = "CHANGE_ME_!!!!"

          -- read from url params
          local args = ngx.req.get_uri_args()
          local ip = args["ip"] or "127.0.0.1"
          local port = args["port"] or  "5900"
          local sign = args["sign"]
          local t = tonumber(args["t"]) or 0
          local elapse = ngx.time() - t

          -- make sure the signature are generated within 30 seconds
  --        if elapse > 30 or elapse < 0  then
  --            ngx.exit(ngx.HTTP_FORBIDDEN)
  --        end

          local addr = ip .. ":" .. port

          -- verify the signature
  --        if ngx.md5(key .. t .. addr .. key) ~= sign then
  --            ngx.exit(ngx.HTTP_FORBIDDEN)
  --        end

          ngx.var.dst_addr = addr
      ';

      websockify_pass $dst_addr;
    }
}
